<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Nvim documentation: lsp-extension</title>
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,900" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.0/normalize.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link href="/css/main.css" rel="stylesheet">
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    
  </head>
  <body>
    <header class="navbar">
      <div class="container">
        <nav class="navbar">
          <div class="container-fluid">
            <div class="navbar-header">

              <a href="/" class="navbar-brand">
                <img src="/images/logo@2x.png" id="navbar-logo" alt="Neovim">
              </a>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <div class="container">
      <h1>Nvim documentation: lsp-extension</h1>
<A NAME="top"></A>
<A HREF="index.html">main help file</A>

<HR>
<PRE>

*<A NAME="lsp-extension.txt"></A><B>lsp-extension.txt</B>*   <A HREF="lsp.html#LSP">LSP</A> Extension

                            NVIM REFERENCE MANUAL


The `vim.lsp` <A HREF="lua.html#Lua">Lua</A> module is a framework for building <A HREF="lsp.html#LSP">LSP</A> plugins.

  1. Start with |<A HREF="vim.html">vim.lsp.start_client()</A>| and |<A HREF="vim.html">vim.lsp.buf_attach_client()</A>|.
  2. Peek at the <A HREF="api.html#API">API</A>:
<B>       :lua print(vim.inspect(vim.lsp))</B>
   3. See |<A HREF="#lsp-extension-example">lsp-extension-example</A>| for a full example.

================================================================================

<A HREF="lsp.html#LSP">LSP</A> EXAMPLE                                            *<A NAME="lsp-extension-example"></A><B>lsp-extension-example</B>*

This example is for <A HREF="usr_05.html#plugin">plugin</A> authors or users who want a lot of <A HREF="intro.html#control">control</A>. If you
are just getting started see |<A HREF="lsp.html#lsp-quickstart">lsp-quickstart</A>|.

For more advanced configurations where just filtering by <A HREF="filetype.html#filetype">filetype</A> isn't
sufficient, you can use the `vim.lsp.start_client()` and
`vim.lsp.buf_attach_client()` commands to easily customize the configuration
however you please. For example, if you want to <A HREF="diff.html#do">do</A> your own filtering, or
start a new <A HREF="lsp.html#LSP">LSP</A> client based on the root directory for working with multiple
projects in a single session. To illustrate, the following is a fully working
<A HREF="lua.html#Lua">Lua</A> example.

The example will:
1. Check for each new buffer whether or not we want to start an <A HREF="lsp.html#LSP">LSP</A> client.
2. Try to find a root directory by ascending from the buffer's path.
3. Create a new <A HREF="lsp.html#LSP">LSP</A> for that root directory if one doesn't exist.
4. Attach the buffer to the client for that root directory.


<B>  -- Some path manipulation utilities</B>
<B>  local function is_dir(filename)</B>
<B>    local stat = vim.loop.fs_stat(filename)</B>
<B>    return stat and stat.type == 'directory' or false</B>
<B>  end</B>

<B>  local path_sep = vim.loop.os_uname().sysname == "Windows" and "\\" or "/"</B>
<B>  -- Assumes filepath is a file.</B>
<B>  local function dirname(filepath)</B>
<B>    local is_changed = false</B>
<B>    local result = filepath:gsub(path_sep.."([^"..path_sep.."]+)$", function()</B>
<B>      is_changed = true</B>
<B>      return ""</B>
<B>    end)</B>
<B>    return result, is_changed</B>
<B>  end</B>

<B>  local function path_join(...)</B>
<B>    return table.concat(vim.tbl_flatten {...}, path_sep)</B>
<B>  end</B>

<B>  -- Ascend the buffer's path until we find the rootdir.</B>
<B>  -- is_root_path is a function which returns bool</B>
<B>  local function buffer_find_root_dir(bufnr, is_root_path)</B>
<B>    local bufname = vim.api.nvim_buf_get_name(bufnr)</B>
<B>    if vim.fn.filereadable(bufname) == 0 then</B>
<B>      return nil</B>
<B>    end</B>
<B>    local dir = bufname</B>
<B>    -- Just in case our algo is buggy, don't infinite loop.</B>
<B>    for _ = 1, 100 do</B>
<B>      local did_change</B>
<B>      dir, did_change = dirname(dir)</B>
<B>      if is_root_path(dir, bufname) then</B>
<B>        return dir, bufname</B>
<B>      end</B>
<B>      -- If we can't ascend further, then stop looking.</B>
<B>      if not did_change then</B>
<B>        return nil</B>
<B>      end</B>
<B>    end</B>
<B>  end</B>

<B>  -- A table to store our root_dir to client_id lookup. We want one LSP per</B>
<B>  -- root directory, and this is how we assert that.</B>
<B>  local javascript_lsps = {}</B>
<B>  -- Which filetypes we want to consider.</B>
<B>  local javascript_filetypes = {</B>
<B>    ["javascript.jsx"] = true;</B>
<B>    ["javascript"]     = true;</B>
<B>    ["typescript"]     = true;</B>
<B>    ["typescript.jsx"] = true;</B>
<B>  }</B>

<B>  -- Create a template configuration for a server to start, minus the root_dir</B>
<B>  -- which we will specify later.</B>
<B>  local javascript_lsp_config = {</B>
<B>    name = "javascript";</B>
<B>    cmd = { path_join(os.getenv("JAVASCRIPT_LANGUAGE_SERVER_DIRECTORY"), "lib", "language-server-stdio.js") };</B>
<B>  }</B>

<B>  -- This needs to be global so that we can call it from the autocmd.</B>
<B>  function check_start_javascript_lsp()</B>
<B>    local bufnr = vim.api.nvim_get_current_buf()</B>
<B>    -- Filter which files we are considering.</B>
<B>    if not javascript_filetypes[vim.api.nvim_buf_get_option(bufnr, 'filetype')] then</B>
<B>      return</B>
<B>    end</B>
<B>    -- Try to find our root directory. We will define this as a directory which contains</B>
<B>    -- node_modules. Another choice would be to check for `package.json`, or for `.git`.</B>
<B>    local root_dir = buffer_find_root_dir(bufnr, function(dir)</B>
<B>      return is_dir(path_join(dir, 'node_modules'))</B>
<B>      -- return vim.fn.filereadable(path_join(dir, 'package.json')) == 1</B>
<B>      -- return is_dir(path_join(dir, '.git'))</B>
<B>    end)</B>
<B>    -- We couldn't find a root directory, so ignore this file.</B>
<B>    if not root_dir then return end</B>

<B>    -- Check if we have a client already or start and store it.</B>
<B>    local client_id = javascript_lsps[root_dir]</B>
<B>    if not client_id then</B>
<B>      local new_config = vim.tbl_extend("error", javascript_lsp_config, {</B>
<B>        root_dir = root_dir;</B>
<B>      })</B>
<B>      client_id = vim.lsp.start_client(new_config)</B>
<B>      javascript_lsps[root_dir] = client_id</B>
<B>    end</B>
<B>    -- Finally, attach to the buffer to track changes. This will do nothing if we</B>
<B>    -- are already attached.</B>
<B>    vim.lsp.buf_attach_client(bufnr, client_id)</B>
<B>  end</B>

<B>  vim.api.nvim_command [[autocmd BufReadPost * lua check_start_javascript_lsp()]]</B>
 

<A HREF="#top">top</A> - <A HREF="index.html">main help file</A>
</PRE>
    </div>

    <footer>
      <div class="container">
        Generated Fri Apr 30 05:44:47 UTC 2021 from <a href="https://github.com/neovim/neovim/commit/59eae3b38fc98ba8c14e681b6d231e9821a11d52"><code>59eae3b</code></a>.
      </div>
    </footer>
  </body>
</html>
